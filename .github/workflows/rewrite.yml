name: Build nxdumptool 'rewrite' PoC binaries

on:
  push:
    branches: [ rewrite ]

  # Allows you to run this workflow manually from the Actions tab.
  workflow_dispatch:

env:
  DEVKITPRO: "/opt/devkitpro"
  DEVKITARM: "/opt/devkitpro/devkitARM"
  DEVKITPPC: "/opt/devkitpro/devkitPPC"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64
    steps:
      - name: Update packages
        run: |
          sudo -n apt-get update
          sudo -n apt-get upgrade -y patch autoconf automake tar bzip2 diffutils pkgconf fakeroot p7zip-full git
          sudo -n dkp-pacman -Syu --needed --noconfirm

      - name: Silence all git safe directory warnings
        run: git config --global --add safe.directory '*'

      # Workaround: manually use git instead of actions/checkout to parse repository properties (e.g. branch name, commit hash, etc.) on our own.
      - name: Checkout latest nxdumptool-rewrite commit
        run: |
          cd "$GITHUB_WORKSPACE"
          git clone --branch rewrite --recurse-submodules https://github.com/DarkMatterCore/nxdumptool.git

      - name: Checkout latest libnx commit
        run: |
          cd "$GITHUB_WORKSPACE"
          git clone --recurse-submodules https://github.com/switchbrew/libnx.git

      - name: Set workspace permissions
        run: chmod 777 -R "$GITHUB_WORKSPACE"

      - name: Build and install libnx
        run: |
          cd "$GITHUB_WORKSPACE/libnx"
          sudo --preserve-env=DEVKITPRO,DEVKITARM,DEVKITPPC -n make install -j$(nproc)

      - name: Build libusbhsfs dependencies
        run: |
          cd "$GITHUB_WORKSPACE/nxdumptool/libs/libusbhsfs"
          sudo --preserve-env=DEVKITPRO,DEVKITARM,DEVKITPPC -n make fs-libs -j$(nproc)

      - name: Build nxdumptool
        run: |
          cd "$GITHUB_WORKSPACE/nxdumptool"
          export COMMIT=$(git rev-parse --short HEAD)
          ./build.sh

      - uses: actions/upload-artifact@v3
        with:
          name: nxdumptool-rewrite_poc_${{ env.COMMIT }}.7z
          path: nxdumptool-rewrite_poc_${{ env.COMMIT }}.7z
          if-no-files-found: error

      - uses: actions/upload-artifact@v3
        with:
          name: nxdumptool-rewrite_poc_${{ env.COMMIT }}-Debug_ELFs.7z
          path: nxdumptool-rewrite_poc_${{ env.COMMIT }}-Debug_ELFs.7z
          if-no-files-found: error
